/****************************************************************
* FILENAME:     DCT_REG.c
* DESCRIPTION:  DCT controller (regulator) which is reducing periodic disturbance
* AUTHOR:       Denis Sušin
* START DATE:   29.8.2017
* VERSION:      1.0
*
* CHANGES :
* VERSION   DATE        WHO             DETAIL
*
****************************************************************/

#include "DCT_REG.h"

// globalne spremenljivke

// spremenljivke za FIR filter iz FPU modula

// Create an Instance of FIRFILT_GEN module and place the object in "firfilt" section
#pragma DATA_SECTION(firFP, "firfilt")
FIR_FP  firFP = FIR_FP_DEFAULTS;
// Define the Delay buffer for the 50th order filterfilter and place it in "firldb" section
#pragma DATA_SECTION(dbuffer, "firldb")
// Align the delay buffer for max 1024 words (512 float variables)
#pragma DATA_ALIGN (dbuffer,0x400)
float dbuffer[FIR_FILTER_NUMBER_OF_COEFF];
// Define Constant Co-efficient Array  and place the .constant section in ROM memory
#pragma DATA_SECTION(coeff, "coefffilt");
// Align the coefficent buffer for max 1024 words (512 float coeff)
#pragma DATA_ALIGN (coeff,0x400)
// DCT filter - 400 coefficients
#if (FIR_FILTER_NUMBER_OF_COEFF == 400)
    float const coeff[FIR_FILTER_NUMBER_OF_COEFF] =                                                                \
            { \
             0.0049993831624, 0.0049975328018, 0.0049944493748, 0.0049901336421, 0.0049845866687, 0.0049778098230, \
             0.0049698047773, 0.0049605735066, 0.0049501182886, 0.0049384417030, 0.0049255466308, 0.0049114362536, \
             0.0048961140531, 0.0048795838097, 0.0048618496020, 0.0048429158056, 0.0048227870923, 0.0048014684284, \
             0.0047789650740, 0.0047552825815, 0.0047304267941, 0.0047044038448, 0.0046772201541, 0.0046488824294, \
             0.0046193976626, 0.0045887731284, 0.0045570163832, 0.0045241352623, 0.0044901378788, 0.0044550326209, \
             0.0044188281504, 0.0043815334002, 0.0043431575722, 0.0043037101350, 0.0042632008218, 0.0042216396275, \
             0.0041790368068, 0.0041354028714, 0.0040907485871, 0.0040450849719, 0.0039984232924, 0.0039507750619, \
             0.0039021520367, 0.0038525662139, 0.0038020298280, 0.0037505553482, 0.0036981554749, 0.0036448431371, \
             0.0035906314888, 0.0035355339059, 0.0034795639830, 0.0034227355296, 0.0033650625675, 0.0033065593266, \
             0.0032472402417, 0.0031871199487, 0.0031262132817, 0.0030645352683, 0.0030021011266, 0.0029389262615, \
             0.0028750262602, 0.0028104168893, 0.0027451140900, 0.0026791339749, 0.0026124928236, 0.0025452070788, \
             0.0024772933422, 0.0024087683705, 0.0023396490713, 0.0022699524987, 0.0021996958493, 0.0021288964578, \
             0.0020575717930, 0.0019857394532, 0.0019134171618, 0.0018406227634, 0.0017673742189, 0.0016936896012, \
             0.0016195870910, 0.0015450849719, 0.0014702016262, 0.0013949555302, 0.0013193652498, 0.0012434494358, \
             0.0011672268193, 0.0010907162070, 0.0010139364768, 0.0009369065729, 0.0008596455014, 0.0007821723252, \
             0.0007045061597, 0.0006266661678, 0.0005486715555, 0.0004705415666, 0.0003922954786, 0.0003139525976, \
             0.0002355322535, 0.0001570537954, 0.0000785365866,-0.0000000000000,-0.0000785365866,-0.0001570537954, \
            -0.0002355322535,-0.0003139525976,-0.0003922954786,-0.0004705415666,-0.0005486715555,-0.0006266661678, \
            -0.0007045061597,-0.0007821723252,-0.0008596455014,-0.0009369065729,-0.0010139364768,-0.0010907162070, \
            -0.0011672268193,-0.0012434494358,-0.0013193652498,-0.0013949555302,-0.0014702016262,-0.0015450849719, \
            -0.0016195870910,-0.0016936896012,-0.0017673742189,-0.0018406227634,-0.0019134171618,-0.0019857394532, \
            -0.0020575717930,-0.0021288964578,-0.0021996958493,-0.0022699524987,-0.0023396490713,-0.0024087683705, \
            -0.0024772933422,-0.0025452070788,-0.0026124928236,-0.0026791339749,-0.0027451140900,-0.0028104168893, \
            -0.0028750262602,-0.0029389262615,-0.0030021011266,-0.0030645352683,-0.0031262132817,-0.0031871199487, \
            -0.0032472402417,-0.0033065593266,-0.0033650625675,-0.0034227355296,-0.0034795639830,-0.0035355339059, \
            -0.0035906314888,-0.0036448431371,-0.0036981554749,-0.0037505553482,-0.0038020298280,-0.0038525662139, \
            -0.0039021520367,-0.0039507750619,-0.0039984232924,-0.0040450849719,-0.0040907485871,-0.0041354028714, \
            -0.0041790368068,-0.0042216396275,-0.0042632008218,-0.0043037101350,-0.0043431575722,-0.0043815334002, \
            -0.0044188281504,-0.0044550326209,-0.0044901378788,-0.0045241352623,-0.0045570163832,-0.0045887731284, \
            -0.0046193976626,-0.0046488824294,-0.0046772201541,-0.0047044038448,-0.0047304267941,-0.0047552825815, \
            -0.0047789650740,-0.0048014684284,-0.0048227870923,-0.0048429158056,-0.0048618496020,-0.0048795838097, \
            -0.0048961140531,-0.0049114362536,-0.0049255466308,-0.0049384417030,-0.0049501182886,-0.0049605735066, \
            -0.0049698047773,-0.0049778098230,-0.0049845866687,-0.0049901336421,-0.0049944493748,-0.0049975328018, \
            -0.0049993831624,-0.0050000000000,-0.0049993831624,-0.0049975328018,-0.0049944493748,-0.0049901336421, \
            -0.0049845866687,-0.0049778098230,-0.0049698047773,-0.0049605735066,-0.0049501182886,-0.0049384417030, \
            -0.0049255466308,-0.0049114362536,-0.0048961140531,-0.0048795838097,-0.0048618496020,-0.0048429158056, \
            -0.0048227870923,-0.0048014684284,-0.0047789650740,-0.0047552825815,-0.0047304267941,-0.0047044038448, \
            -0.0046772201541,-0.0046488824294,-0.0046193976626,-0.0045887731284,-0.0045570163832,-0.0045241352623, \
            -0.0044901378788,-0.0044550326209,-0.0044188281504,-0.0043815334002,-0.0043431575722,-0.0043037101350, \
            -0.0042632008218,-0.0042216396275,-0.0041790368068,-0.0041354028714,-0.0040907485871,-0.0040450849719, \
            -0.0039984232924,-0.0039507750619,-0.0039021520367,-0.0038525662139,-0.0038020298280,-0.0037505553482, \
            -0.0036981554749,-0.0036448431371,-0.0035906314888,-0.0035355339059,-0.0034795639830,-0.0034227355296, \
            -0.0033650625675,-0.0033065593266,-0.0032472402417,-0.0031871199487,-0.0031262132817,-0.0030645352683, \
            -0.0030021011266,-0.0029389262615,-0.0028750262602,-0.0028104168893,-0.0027451140900,-0.0026791339749, \
            -0.0026124928236,-0.0025452070788,-0.0024772933422,-0.0024087683705,-0.0023396490713,-0.0022699524987, \
            -0.0021996958493,-0.0021288964578,-0.0020575717930,-0.0019857394532,-0.0019134171618,-0.0018406227634, \
            -0.0017673742189,-0.0016936896012,-0.0016195870910,-0.0015450849719,-0.0014702016262,-0.0013949555302, \
            -0.0013193652498,-0.0012434494358,-0.0011672268193,-0.0010907162070,-0.0010139364768,-0.0009369065729, \
            -0.0008596455014,-0.0007821723252,-0.0007045061597,-0.0006266661678,-0.0005486715555,-0.0004705415666, \
            -0.0003922954786,-0.0003139525976,-0.0002355322535,-0.0001570537954,-0.0000785365866, 0.0000000000000, \
             0.0000785365866, 0.0001570537954, 0.0002355322535, 0.0003139525976, 0.0003922954786, 0.0004705415666, \
             0.0005486715555, 0.0006266661678, 0.0007045061597, 0.0007821723252, 0.0008596455014, 0.0009369065729, \
             0.0010139364768, 0.0010907162070, 0.0011672268193, 0.0012434494358, 0.0013193652498, 0.0013949555302, \
             0.0014702016262, 0.0015450849719, 0.0016195870910, 0.0016936896012, 0.0017673742189, 0.0018406227634, \
             0.0019134171618, 0.0019857394532, 0.0020575717930, 0.0021288964578, 0.0021996958493, 0.0022699524987, \
             0.0023396490713, 0.0024087683705, 0.0024772933422, 0.0025452070788, 0.0026124928236, 0.0026791339749, \
             0.0027451140900, 0.0028104168893, 0.0028750262602, 0.0029389262615, 0.0030021011266, 0.0030645352683, \
             0.0031262132817, 0.0031871199487, 0.0032472402417, 0.0033065593266, 0.0033650625675, 0.0034227355296, \
             0.0034795639830, 0.0035355339059, 0.0035906314888, 0.0036448431371, 0.0036981554749, 0.0037505553482, \
             0.0038020298280, 0.0038525662139, 0.0039021520367, 0.0039507750619, 0.0039984232924, 0.0040450849719, \
             0.0040907485871, 0.0041354028714, 0.0041790368068, 0.0042216396275, 0.0042632008218, 0.0043037101350, \
             0.0043431575722, 0.0043815334002, 0.0044188281504, 0.0044550326209, 0.0044901378788, 0.0045241352623, \
             0.0045570163832, 0.0045887731284, 0.0046193976626, 0.0046488824294, 0.0046772201541, 0.0047044038448, \
             0.0047304267941, 0.0047552825815, 0.0047789650740, 0.0048014684284, 0.0048227870923, 0.0048429158056, \
             0.0048618496020, 0.0048795838097, 0.0048961140531, 0.0049114362536, 0.0049255466308, 0.0049384417030, \
             0.0049501182886, 0.0049605735066, 0.0049698047773, 0.0049778098230, 0.0049845866687, 0.0049901336421, \
             0.0049944493748, 0.0049975328018, 0.0049993831624, 0.0050000000000 \
            };

//    float const coeff[FIR_FILTER_NUMBER_OF_COEFF] =                                                                \
    		{ \
    		 0.0049384417030, 0.0049255466308, 0.0049114362536, 0.0048961140531, 0.0048795838097, 0.0048618496020, \
    		 0.0048429158056, 0.0048227870923, 0.0048014684284, 0.0047789650740, 0.0047552825815, 0.0047304267941, \
    		 0.0047044038448, 0.0046772201541, 0.0046488824294, 0.0046193976626, 0.0045887731284, 0.0045570163832, \
    		 0.0045241352623, 0.0044901378788, 0.0044550326209, 0.0044188281504, 0.0043815334002, 0.0043431575722, \
    		 0.0043037101350, 0.0042632008218, 0.0042216396275, 0.0041790368068, 0.0041354028714, 0.0040907485871, \
    		 0.0040450849719, 0.0039984232924, 0.0039507750619, 0.0039021520367, 0.0038525662139, 0.0038020298280, \
    		 0.0037505553482, 0.0036981554749, 0.0036448431371, 0.0035906314888, 0.0035355339059, 0.0034795639830, \
    		 0.0034227355296, 0.0033650625675, 0.0033065593266, 0.0032472402417, 0.0031871199487, 0.0031262132817, \
    		 0.0030645352683, 0.0030021011266, 0.0029389262615, 0.0028750262602, 0.0028104168893, 0.0027451140900, \
    		 0.0026791339749, 0.0026124928236, 0.0025452070788, 0.0024772933422, 0.0024087683705, 0.0023396490713, \
    		 0.0022699524987, 0.0021996958493, 0.0021288964578, 0.0020575717930, 0.0019857394532, 0.0019134171618, \
    		 0.0018406227634, 0.0017673742189, 0.0016936896012, 0.0016195870910, 0.0015450849719, 0.0014702016262, \
    		 0.0013949555302, 0.0013193652498, 0.0012434494358, 0.0011672268193, 0.0010907162070, 0.0010139364768, \
    		 0.0009369065729, 0.0008596455014, 0.0007821723252, 0.0007045061597, 0.0006266661678, 0.0005486715555, \
    		 0.0004705415666, 0.0003922954786, 0.0003139525976, 0.0002355322535, 0.0001570537954, 0.0000785365866, \
    		 0.0000000000000,-0.0000785365866,-0.0001570537954,-0.0002355322535,-0.0003139525976,-0.0003922954786, \
    		-0.0004705415666,-0.0005486715555,-0.0006266661678,-0.0007045061597,-0.0007821723252,-0.0008596455014, \
    		-0.0009369065729,-0.0010139364768,-0.0010907162070,-0.0011672268193,-0.0012434494358,-0.0013193652498, \
    		-0.0013949555302,-0.0014702016262,-0.0015450849719,-0.0016195870910,-0.0016936896012,-0.0017673742189, \
    		-0.0018406227634,-0.0019134171618,-0.0019857394532,-0.0020575717930,-0.0021288964578,-0.0021996958493, \
    		-0.0022699524987,-0.0023396490713,-0.0024087683705,-0.0024772933422,-0.0025452070788,-0.0026124928236, \
    		-0.0026791339749,-0.0027451140900,-0.0028104168893,-0.0028750262602,-0.0029389262615,-0.0030021011266, \
    		-0.0030645352683,-0.0031262132817,-0.0031871199487,-0.0032472402417,-0.0033065593266,-0.0033650625675, \
    		-0.0034227355296,-0.0034795639830,-0.0035355339059,-0.0035906314888,-0.0036448431371,-0.0036981554749, \
    		-0.0037505553482,-0.0038020298280,-0.0038525662139,-0.0039021520367,-0.0039507750619,-0.0039984232924, \
    		-0.0040450849719,-0.0040907485871,-0.0041354028714,-0.0041790368068,-0.0042216396275,-0.0042632008218, \
    		-0.0043037101350,-0.0043431575722,-0.0043815334002,-0.0044188281504,-0.0044550326209,-0.0044901378788, \
    		-0.0045241352623,-0.0045570163832,-0.0045887731284,-0.0046193976626,-0.0046488824294,-0.0046772201541, \
    		-0.0047044038448,-0.0047304267941,-0.0047552825815,-0.0047789650740,-0.0048014684284,-0.0048227870923, \
    		-0.0048429158056,-0.0048618496020,-0.0048795838097,-0.0048961140531,-0.0049114362536,-0.0049255466308, \
    		-0.0049384417030,-0.0049501182886,-0.0049605735066,-0.0049698047773,-0.0049778098230,-0.0049845866687, \
    		-0.0049901336421,-0.0049944493748,-0.0049975328018,-0.0049993831624,-0.0050000000000,-0.0049993831624, \
    		-0.0049975328018,-0.0049944493748,-0.0049901336421,-0.0049845866687,-0.0049778098230,-0.0049698047773, \
    		-0.0049605735066,-0.0049501182886,-0.0049384417030,-0.0049255466308,-0.0049114362536,-0.0048961140531, \
    		-0.0048795838097,-0.0048618496020,-0.0048429158056,-0.0048227870923,-0.0048014684284,-0.0047789650740, \
    		-0.0047552825815,-0.0047304267941,-0.0047044038448,-0.0046772201541,-0.0046488824294,-0.0046193976626, \
    		-0.0045887731284,-0.0045570163832,-0.0045241352623,-0.0044901378788,-0.0044550326209,-0.0044188281504, \
    		-0.0043815334002,-0.0043431575722,-0.0043037101350,-0.0042632008218,-0.0042216396275,-0.0041790368068, \
    		-0.0041354028714,-0.0040907485871,-0.0040450849719,-0.0039984232924,-0.0039507750619,-0.0039021520367, \
    		-0.0038525662139,-0.0038020298280,-0.0037505553482,-0.0036981554749,-0.0036448431371,-0.0035906314888, \
    		-0.0035355339059,-0.0034795639830,-0.0034227355296,-0.0033650625675,-0.0033065593266,-0.0032472402417, \
    		-0.0031871199487,-0.0031262132817,-0.0030645352683,-0.0030021011266,-0.0029389262615,-0.0028750262602, \
    		-0.0028104168893,-0.0027451140900,-0.0026791339749,-0.0026124928236,-0.0025452070788,-0.0024772933422, \
    		-0.0024087683705,-0.0023396490713,-0.0022699524987,-0.0021996958493,-0.0021288964578,-0.0020575717930, \
    		-0.0019857394532,-0.0019134171618,-0.0018406227634,-0.0017673742189,-0.0016936896012,-0.0016195870910, \
    		-0.0015450849719,-0.0014702016262,-0.0013949555302,-0.0013193652498,-0.0012434494358,-0.0011672268193, \
    		-0.0010907162070,-0.0010139364768,-0.0009369065729,-0.0008596455014,-0.0007821723252,-0.0007045061597, \
    		-0.0006266661678,-0.0005486715555,-0.0004705415666,-0.0003922954786,-0.0003139525976,-0.0002355322535, \
    		-0.0001570537954,-0.0000785365866,-0.0000000000000, 0.0000785365866, 0.0001570537954, 0.0002355322535, \
    		 0.0003139525976, 0.0003922954786, 0.0004705415666, 0.0005486715555, 0.0006266661678, 0.0007045061597, \
    		 0.0007821723252, 0.0008596455014, 0.0009369065729, 0.0010139364768, 0.0010907162070, 0.0011672268193, \
    		 0.0012434494358, 0.0013193652498, 0.0013949555302, 0.0014702016262, 0.0015450849719, 0.0016195870910, \
    		 0.0016936896012, 0.0017673742189, 0.0018406227634, 0.0019134171618, 0.0019857394532, 0.0020575717930, \
    		 0.0021288964578, 0.0021996958493, 0.0022699524987, 0.0023396490713, 0.0024087683705, 0.0024772933422, \
    		 0.0025452070788, 0.0026124928236, 0.0026791339749, 0.0027451140900, 0.0028104168893, 0.0028750262602, \
    		 0.0029389262615, 0.0030021011266, 0.0030645352683, 0.0031262132817, 0.0031871199487, 0.0032472402417, \
    		 0.0033065593266, 0.0033650625675, 0.0034227355296, 0.0034795639830, 0.0035355339059, 0.0035906314888, \
    		 0.0036448431371, 0.0036981554749, 0.0037505553482, 0.0038020298280, 0.0038525662139, 0.0039021520367, \
    		 0.0039507750619, 0.0039984232924, 0.0040450849719, 0.0040907485871, 0.0041354028714, 0.0041790368068, \
    		 0.0042216396275, 0.0042632008218, 0.0043037101350, 0.0043431575722, 0.0043815334002, 0.0044188281504, \
    		 0.0044550326209, 0.0044901378788, 0.0045241352623, 0.0045570163832, 0.0045887731284, 0.0046193976626, \
    		 0.0046488824294, 0.0046772201541, 0.0047044038448, 0.0047304267941, 0.0047552825815, 0.0047789650740, \
    		 0.0048014684284, 0.0048227870923, 0.0048429158056, 0.0048618496020, 0.0048795838097, 0.0048961140531, \
    		 0.0049114362536, 0.0049255466308, 0.0049384417030, 0.0049501182886, 0.0049605735066, 0.0049698047773, \
    		 0.0049778098230, 0.0049845866687, 0.0049901336421, 0.0049944493748, 0.0049975328018, 0.0049993831624, \
    		 0.0050000000000, 0.0049993831624, 0.0049975328018, 0.0049944493748, 0.0049901336421, 0.0049845866687, \
    		 0.0049778098230, 0.0049698047773, 0.0049605735066, 0.0049501182886 \
    		};
#endif


// funkcija
#pragma CODE_SECTION(DCT_REG_CALC, "ramfuncs");
void DCT_REG_CALC (DCT_REG_float *v)
{
    // lokalne spremenljivke
	static int first_start = 0;




    // program

    // omejitev dolžine circular bufferja
    if (v->BufferHistoryLength > FIR_FILTER_NUMBER_OF_COEFF)
    {
        v->BufferHistoryLength = FIR_FILTER_NUMBER_OF_COEFF;
    }
    else if (v->BufferHistoryLength < 1)
    {
        v->BufferHistoryLength = 1;
    }

    // omejitev kompenzacije zakasnitve, ki ne sme presegati dolžine bufferja
    if (v->k > FIR_FILTER_NUMBER_OF_COEFF)
    {
        v->k = FIR_FILTER_NUMBER_OF_COEFF;
    }
    else if (v->k < 0)
    {
        v->k = 0;
    }

    // omejitev vzorènega signala med 0.0 in 0.9999 (SamplingSignal ne sme biti enak ena, ker mora biti indeks i omejen od 0 do BufferHistoryLength-1)
    v->SamplingSignal = (v->SamplingSignal > 0.99999)? 0.99999: v->SamplingSignal;
    v->SamplingSignal = (v->SamplingSignal < 0.0)? 0.0: v->SamplingSignal;





    // izraèun trenutnega indeksa bufferja
    v->i = (int)(v->SamplingSignal * v->BufferHistoryLength);




    // èe se indeks spremeni, potem gre algoritem dalje (vsako periodo signala, ne pa vsako vzorèno periodo/interval)
    if ((v->i != v->i_prev) || (first_start == 0))
    {
    	if(v->i != v->i_prev)
    	{
			// ko je program prviè na tem mestu, dvignemo zastavico
			first_start = 1;
    	}

    	/***************************************************/
		/* circular buffer */
    	/***************************************************/

		// manipuliranje z indeksi - zaradi circular bufferja
    	if ( (v->i > v->i_prev) || (v->i - v->i_prev == -(v->BufferHistoryLength - 1)) || (first_start == 0) )
		{
			// indeks, ki kaže v preteklost (potrebujem za ponovno zakasnitev, ki je že kompenzirana z DCT filtrom)
			v->index = v->i - v->k;

			// omejitve zaradi circular bufferja
			if (v->index < 0)
			{
				v->index = v->index + v->BufferHistoryLength;
			}
		} // end of if (v->i > v->i_prev)
        else if ( (v->i < v->i_prev) || (v->i - v->i_prev == (v->BufferHistoryLength - 1)) )
		{
			// indeks, ki kaže v preteklost (potrebujem za ponovno zakasnitev, ki je že kompenzirana z DCT filtrom)
			v->index = v->i + v->k;

			// omejitve zaradi circular bufferja
			if (v->index > (v->BufferHistoryLength - 1))
			{
				v->index = v->index - v->BufferHistoryLength;
			}
		} // end of else if (v->i < v->i_prev)




		/***************************************************/
		/* koda DCT regulatorja */
		/***************************************************/

		// izraèunam trenutni error
		v->Err = v->Ref - v->Fdb;

		// izraèunam novi akumuliran error
		v->ErrSum = v->Kdct * v->Err +
					v->CorrectionHistory[v->index];
	/*
		// omejim trenutni error, da ne gre v nasièenje
		v->ErrSum = (v->ErrSum > v->ErrSumMax)? v->ErrSumMax: v->ErrSum;
		v->ErrSum = (v->ErrSum < v->ErrSumMin)? v->ErrSumMin: v->ErrSum;
	*/




		/* DCT filter - FIR filter */
		firFP.input = v->ErrSum;
		firFP.calc(&firFP);
		v->Correction = firFP.output;

		// zapišem trenutno vrednost korekcijskega signala v buffer na trenutno mesto
		v->CorrectionHistory[v->i] = v->Correction;

		// izraèunam izhod
		v->Out = v->Correction;


	    // shranim vrednost indeksa i, ki bo v naslednjem ciklu prejšnji i
	    v->i_prev = v->i;




    } // end of if (i != i_prev)




    // omejim izhod
    v->Out = (v->Out > v->OutMax)? v->OutMax: v->Out;
    v->Out = (v->Out < v->OutMin)? v->OutMin: v->Out;




} // konec funkcije
